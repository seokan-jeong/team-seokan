<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Team-Shinchan Dashboard</title>
  <style>
    /* â”€â”€ ë¦¬ì…‹ & ê¸°ë³¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      --bg:          #0d1117;
      --card-bg:     #161b22;
      --border:      #30363d;
      --text:        #e6edf3;
      --text-muted:  #8b949e;
      --accent:      #58a6ff;
      --success:     #3fb950;
      --warning:     #d29922;
      --error:       #f85149;
      --sidebar-w:   220px;
      --header-h:    56px;
      --footer-h:    44px;
    }

    html, body {
      height: 100%;
      background: var(--bg);
      color: var(--text);
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      font-size: 14px;
      line-height: 1.5;
    }

    /* â”€â”€ ë ˆì´ì•„ì›ƒ ê·¸ë¦¬ë“œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .app {
      display: grid;
      grid-template-rows: var(--header-h) 1fr var(--footer-h);
      grid-template-columns: var(--sidebar-w) 1fr;
      grid-template-areas:
        "header  header"
        "sidebar main"
        "footer  footer";
      height: 100vh;
      overflow: hidden;
    }

    /* â”€â”€ í—¤ë” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .header {
      grid-area: header;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      background: var(--card-bg);
      border-bottom: 1px solid var(--border);
      z-index: 10;
    }

    .header-brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .header-brand .logo {
      font-size: 22px;
    }

    .header-brand h1 {
      font-size: 16px;
      font-weight: 600;
      color: var(--text);
      letter-spacing: 0.3px;
    }

    .header-brand .subtitle {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 1px;
    }

    /* ì—°ê²° ìƒíƒœ ë°°ì§€ */
    .conn-badge {
      display: flex;
      align-items: center;
      gap: 7px;
      padding: 5px 12px;
      border-radius: 20px;
      background: rgba(255,255,255,0.04);
      border: 1px solid var(--border);
      font-size: 12px;
      color: var(--text-muted);
      transition: all 0.3s ease;
    }

    .conn-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--text-muted);
      transition: background 0.3s ease;
    }

    .conn-badge.connected .conn-dot {
      background: var(--success);
      box-shadow: 0 0 6px var(--success);
      animation: pulse-dot 2s infinite;
    }

    .conn-badge.connected     { color: var(--success); border-color: rgba(63,185,80,0.3); }
    .conn-badge.disconnected  .conn-dot { background: var(--error); box-shadow: 0 0 6px var(--error); }
    .conn-badge.disconnected  { color: var(--error); border-color: rgba(248,81,73,0.3); }
    .conn-badge.reconnecting  .conn-dot { background: var(--warning); box-shadow: 0 0 6px var(--warning); animation: pulse-dot 1s infinite; }
    .conn-badge.reconnecting  { color: var(--warning); border-color: rgba(210,153,34,0.3); }

    @keyframes pulse-dot {
      0%, 100% { opacity: 1; }
      50%       { opacity: 0.5; }
    }

    /* â”€â”€ ì—°ê²° ëŠê¹€ ì•Œë¦¼ ë°” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .conn-alert-bar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 100;
      background: rgba(248,81,73,0.95);
      color: #fff;
      font-size: 13px;
      font-weight: 600;
      text-align: center;
      padding: 10px 20px;
      transform: translateY(-100%);
      transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .conn-alert-bar.visible {
      transform: translateY(0);
    }

    .conn-alert-bar.reconnecting-bar {
      background: rgba(210,153,34,0.95);
    }

    /* â”€â”€ ì‚¬ì´ë“œë°” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .sidebar {
      grid-area: sidebar;
      background: var(--card-bg);
      border-right: 1px solid var(--border);
      overflow-y: auto;
      padding: 12px 8px;
      scrollbar-width: thin;
      scrollbar-color: var(--border) transparent;
    }

    .sidebar::-webkit-scrollbar { width: 4px; }
    .sidebar::-webkit-scrollbar-track { background: transparent; }
    .sidebar::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

    /* ë ˆì´ì–´ ê·¸ë£¹ */
    .layer-group {
      margin-bottom: 14px;
    }

    .layer-label {
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--text-muted);
      padding: 0 6px 6px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 6px;
    }

    /* ì—ì´ì „íŠ¸ ì¹´ë“œ */
    .agent-card {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 7px 8px;
      border-radius: 8px;
      cursor: default;
      /* ìƒíƒœ ì „í™˜ ì‹œ ë¶€ë“œëŸ¬ìš´ íŠ¸ëœì§€ì…˜ */
      transition: background 0.3s ease, border-color 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .agent-card:hover { background: rgba(255,255,255,0.04); }

    .agent-emoji {
      font-size: 20px;
      flex-shrink: 0;
      width: 28px;
      text-align: center;
    }

    .agent-info {
      flex: 1;
      min-width: 0;
    }

    .agent-name {
      font-size: 12px;
      font-weight: 600;
      color: var(--text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .agent-role {
      font-size: 10px;
      color: var(--text-muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* ì—ì´ì „íŠ¸ ìƒíƒœ í‘œì‹œ */
    .agent-status {
      flex-shrink: 0;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--border);
      transition: background 0.3s ease, box-shadow 0.3s ease;
    }

    /* idle */
    .agent-card[data-status="idle"] .agent-status {
      background: var(--border);
    }

    /* working - ë…¹ìƒ‰ í„ìŠ¤ */
    .agent-card[data-status="working"] .agent-status {
      background: var(--success);
      box-shadow: 0 0 0 0 rgba(63,185,80,0.7);
      animation: pulse-ring 1.5s infinite;
    }

    /* completed */
    .agent-card[data-status="completed"] .agent-status {
      background: var(--accent);
    }

    @keyframes pulse-ring {
      0%   { box-shadow: 0 0 0 0 rgba(63,185,80,0.7); }
      70%  { box-shadow: 0 0 0 6px rgba(63,185,80,0); }
      100% { box-shadow: 0 0 0 0 rgba(63,185,80,0); }
    }

    /* working ìƒíƒœ ì¹´ë“œ ë°°ê²½ ê°•ì¡° */
    .agent-card[data-status="working"] {
      background: rgba(63,185,80,0.05);
    }

    /* ì—ì´ì „íŠ¸ ì¹´ë“œ ë§ˆì§€ë§‰ ë©”ì‹œì§€ ë¯¸ë¦¬ë³´ê¸° */
    .agent-preview {
      font-size: 10px;
      color: var(--text-muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-top: 2px;
      max-width: 100%;
      display: none; /* ë©”ì‹œì§€ê°€ ìˆì„ ë•Œë§Œ ë³´ì„ */
    }

    .agent-preview.visible {
      display: block;
    }

    /* ì²´í¬ë§ˆí¬ ì˜¤ë²„ë ˆì´ (agent_done ì‹œ ì ê¹ í‘œì‹œ) */
    .agent-check {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 14px;
      color: var(--success);
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
    }

    .agent-check.show {
      opacity: 1;
    }

    /* â”€â”€ ë©”ì¸ ì˜ì—­ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .main {
      grid-area: main;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* â”€â”€ ì›Œí¬í”Œë¡œìš° í”„ë¡œê·¸ë ˆìŠ¤ ë°” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .workflow-bar {
      flex-shrink: 0;
      padding: 14px 20px;
      background: var(--card-bg);
      border-bottom: 1px solid var(--border);
    }

    .workflow-title {
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      color: var(--text-muted);
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .phase-info {
      background: rgba(88,166,255,0.12);
      border: 1px solid rgba(88,166,255,0.3);
      color: var(--accent);
      border-radius: 10px;
      padding: 1px 8px;
      font-size: 10px;
    }

    /* ìŠ¤í…Œì´ì§€ ìŠ¤í… */
    .stages {
      display: flex;
      align-items: center;
      gap: 0;
    }

    .stage {
      flex: 1;
      display: flex;
      align-items: center;
    }

    .stage-inner {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 8px;
      transition: all 0.3s ease;
      opacity: 0.4;
    }

    .stage.done .stage-inner    { opacity: 1; }
    .stage.active .stage-inner  { opacity: 1; background: rgba(88,166,255,0.1); border: 1px solid rgba(88,166,255,0.3); }
    .stage.pending .stage-inner { opacity: 0.3; }

    .stage-icon {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 700;
      background: var(--border);
      color: var(--text-muted);
      flex-shrink: 0;
      transition: all 0.3s ease;
    }

    .stage.done .stage-icon    { background: var(--success); color: #fff; }
    .stage.active .stage-icon  { background: var(--accent);  color: #fff; }
    .stage.pending .stage-icon { background: var(--border);  color: var(--text-muted); }

    .stage-text {}
    .stage-num  { font-size: 10px; color: var(--text-muted); }
    .stage-name { font-size: 12px; font-weight: 600; color: var(--text); }

    .stage.active .stage-name { color: var(--accent); }
    .stage.done .stage-name   { color: var(--success); }

    /* ìŠ¤í…Œì´ì§€ ì‚¬ì´ ì—°ê²°ì„  */
    .stage-connector {
      width: 24px;
      height: 2px;
      background: var(--border);
      flex-shrink: 0;
      margin: 0 2px;
      transition: background 0.3s ease;
    }

    .stage-connector.done { background: var(--success); }

    /* â”€â”€ Phase ì§„í–‰ë¥  ì„¹ì…˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .phase-progress-bar {
      flex-shrink: 0;
      padding: 10px 20px 12px;
      background: var(--card-bg);
      border-bottom: 1px solid var(--border);
      display: none; /* phase ì •ë³´ ìˆì„ ë•Œë§Œ í‘œì‹œ */
    }

    .phase-progress-bar.visible {
      display: block;
    }

    .phase-progress-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .phase-progress-label {
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      color: var(--text-muted);
    }

    /* "Phase 2 / 4" í‘œì‹œ í…ìŠ¤íŠ¸ */
    .phase-progress-counter {
      font-size: 11px;
      font-weight: 600;
      color: var(--accent);
    }

    /* Phase ì œëª© (ìˆì„ ë•Œë§Œ í‘œì‹œ) */
    .phase-progress-title {
      font-size: 12px;
      color: var(--text);
      margin-bottom: 8px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Phase ë„íŠ¸ ëª©ë¡ */
    .phase-dots {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    /* ê° Phase ë„íŠ¸ */
    .phase-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      flex-shrink: 0;
      transition: background 0.3s ease, box-shadow 0.3s ease;
    }

    /* ì™„ë£Œëœ Phase */
    .phase-dot.done {
      background: var(--success);
    }

    /* í˜„ì¬ Phase - íŒŒë€ í„ìŠ¤ ì• ë‹ˆë©”ì´ì…˜ */
    .phase-dot.current {
      background: var(--accent);
      box-shadow: 0 0 0 0 rgba(88,166,255,0.7);
      animation: phase-pulse 1.8s infinite;
    }

    /* ë¯¸ë˜ Phase */
    .phase-dot.future {
      background: var(--border);
      opacity: 0.5;
    }

    @keyframes phase-pulse {
      0%   { box-shadow: 0 0 0 0 rgba(88,166,255,0.7); }
      70%  { box-shadow: 0 0 0 5px rgba(88,166,255,0); }
      100% { box-shadow: 0 0 0 0 rgba(88,166,255,0); }
    }

    /* â”€â”€ í™œë™ íƒ€ì„ë¼ì¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .timeline-section {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      padding: 16px 20px;
      gap: 12px;
    }

    .timeline-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }

    .timeline-title {
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      color: var(--text-muted);
    }

    .event-count {
      font-size: 11px;
      color: var(--text-muted);
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 1px 8px;
    }

    /* íƒ€ì„ë¼ì¸ ì»¨í…Œì´ë„ˆ */
    .timeline {
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 6px;
      scrollbar-width: thin;
      scrollbar-color: var(--border) transparent;
    }

    .timeline::-webkit-scrollbar { width: 4px; }
    .timeline::-webkit-scrollbar-track { background: transparent; }
    .timeline::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

    /* ë¹ˆ ìƒíƒœ ë©”ì‹œì§€ */
    .timeline-empty {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      flex: 1;
      gap: 10px;
      color: var(--text-muted);
      text-align: center;
      padding: 40px;
    }

    .timeline-empty .empty-icon { font-size: 48px; opacity: 0.4; margin-bottom: 4px; }
    .timeline-empty .empty-text { font-size: 14px; font-weight: 600; color: var(--text-muted); }
    .timeline-empty .empty-hint { font-size: 12px; opacity: 0.6; max-width: 280px; line-height: 1.5; }

    /* ì´ë²¤íŠ¸ ì•„ì´í…œ */
    .event-item {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 9px 12px;
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      transition: border-color 0.2s ease;
      animation: fadeIn 0.3s ease;
      flex-shrink: 0;
    }

    .event-item:hover { border-color: rgba(88,166,255,0.3); }

    /* íƒ€ì„ë¼ì¸ ì´ë²¤íŠ¸ ë“±ì¥ ì• ë‹ˆë©”ì´ì…˜ (ìœ„ì—ì„œ ìŠ¬ë¼ì´ë“œ) */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-6px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    /* ì±„íŒ… ë©”ì‹œì§€ ë“±ì¥ ì• ë‹ˆë©”ì´ì…˜ (ì•„ë˜ì—ì„œ ìŠ¬ë¼ì´ë“œ ì—…) */
    @keyframes slideUp {
      from { opacity: 0; transform: translateY(10px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    /* ìœ„ì„ ì²´ì¸ ë³€ê²½ ì‹œ fadeIn */
    @keyframes chainFadeIn {
      from { opacity: 0; }
      to   { opacity: 1; }
    }

    .event-time {
      font-size: 11px;
      color: var(--text-muted);
      font-family: 'Courier New', monospace;
      white-space: nowrap;
      margin-top: 1px;
      flex-shrink: 0;
      min-width: 64px;
    }

    .event-emoji {
      font-size: 16px;
      flex-shrink: 0;
      width: 20px;
      text-align: center;
    }

    .event-body {
      flex: 1;
      min-width: 0;
    }

    .event-agent {
      font-size: 12px;
      font-weight: 600;
      color: var(--accent);
      margin-bottom: 1px;
    }

    .event-msg {
      font-size: 12px;
      color: var(--text);
      word-break: break-word;
    }

    /* ì´ë²¤íŠ¸ íƒ€ì…ë³„ ì™¼ìª½ í…Œë‘ë¦¬ ìƒ‰ìƒ (ê¸°ì¡´ í˜¸í™˜) */
    .event-item[data-type="info"]    { border-left: 3px solid var(--accent); }
    .event-item[data-type="success"] { border-left: 3px solid var(--success); }
    .event-item[data-type="warning"] { border-left: 3px solid var(--warning); }
    .event-item[data-type="error"]   { border-left: 3px solid var(--error); }

    /* SSE ì´ë²¤íŠ¸ ì¢…ë¥˜ë³„ ì™¼ìª½ í…Œë‘ë¦¬ ìŠ¤íƒ€ì¼ */
    .event-item[data-etype="agent_start"]     { border-left: 3px solid var(--success); }
    .event-item[data-etype="agent_done"]      { border-left: 3px solid #555; }
    .event-item[data-etype="delegation"]      { border-left: 3px solid var(--accent); background: rgba(88,166,255,0.04); }
    .event-item[data-etype="message"]         { border-left: 3px solid var(--border); }
    .event-item[data-etype="user_prompt"]     { border-left: 3px solid #a855f7; }
    .event-item[data-etype="tool_use"]        { border-left: 3px solid #f97316; }
    .event-item[data-etype="stop"]            { border-left: 3px solid #555; }
    .event-item[data-etype="session_start"]   { border-left: 3px solid var(--success); }
    .event-item[data-etype="session_end"]     { border-left: 3px solid #555; }
    .event-item[data-etype="workflow_update"] { border-left: 3px solid var(--accent); }

    /* delegation ì´ë²¤íŠ¸ íŠ¹ë³„ ìŠ¤íƒ€ì¼: from â†’ to í‘œì‹œ */
    .event-delegation {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      flex-wrap: wrap;
    }

    .delegation-from,
    .delegation-to {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: rgba(88,166,255,0.1);
      border: 1px solid rgba(88,166,255,0.2);
      border-radius: 12px;
      padding: 2px 8px;
      font-size: 11px;
      font-weight: 600;
      color: var(--accent);
    }

    .delegation-arrow {
      font-size: 14px;
      color: var(--text-muted);
    }

    .delegation-task {
      width: 100%;
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 4px;
      font-style: italic;
    }

    /* â”€â”€ ìœ„ì„ íë¦„ ì„¹ì…˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .delegation-section {
      flex-shrink: 0;
      padding: 10px 20px;
      background: var(--card-bg);
      border-bottom: 1px solid var(--border);
      display: none; /* ìœ„ì„ ì—†ìœ¼ë©´ ìˆ¨ê¹€ */
    }

    .delegation-section.visible {
      display: block;
    }

    .delegation-section-title {
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    /* ìœ„ì„ ì²´ì¸ ê°€ë¡œ í‘œì‹œ - ë³€ê²½ ì‹œ fadeIn */
    .delegation-chain {
      display: flex;
      align-items: center;
      gap: 6px;
      overflow-x: auto;
      padding-bottom: 4px;
      scrollbar-width: none;
      animation: chainFadeIn 0.3s ease;
    }

    .delegation-chain::-webkit-scrollbar { display: none; }

    /* ì²´ì¸ ë‚´ ì—ì´ì „íŠ¸ ë…¸ë“œ */
    .chain-node {
      display: flex;
      align-items: center;
      gap: 5px;
      padding: 5px 10px;
      border-radius: 20px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.03);
      white-space: nowrap;
      transition: all 0.3s ease;
      font-size: 12px;
    }

    /* í˜„ì¬ ì‘ì—… ì¤‘ì¸ ë…¸ë“œ í•˜ì´ë¼ì´íŠ¸ */
    .chain-node.active {
      border-color: var(--success);
      background: rgba(63,185,80,0.08);
      color: var(--success);
      box-shadow: 0 0 0 1px rgba(63,185,80,0.2);
    }

    .chain-node .chain-emoji { font-size: 14px; }
    .chain-node .chain-name  { font-size: 11px; font-weight: 600; }

    /* ì²´ì¸ í™”ì‚´í‘œ */
    .chain-arrow {
      color: var(--text-muted);
      font-size: 14px;
      flex-shrink: 0;
    }

    /* â”€â”€ í‘¸í„° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .footer {
      grid-area: footer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      background: var(--card-bg);
      border-top: 1px solid var(--border);
      font-size: 11px;
      color: var(--text-muted);
    }

    .footer-left  { display: flex; align-items: center; gap: 16px; }
    .footer-right { display: flex; align-items: center; gap: 16px; }

    .footer-item {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .footer-item span:first-child { color: var(--text-muted); }
    .footer-item span:last-child  { color: var(--text); }

    /* â”€â”€ íƒ­ ë°” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .tab-bar {
      display: flex;
      align-items: center;
      gap: 0;
      flex-shrink: 0;
      border-bottom: 1px solid var(--border);
      background: var(--card-bg);
      padding: 0 20px;
    }

    .tab {
      background: none;
      border: none;
      border-bottom: 2px solid transparent;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 0.3px;
      padding: 10px 16px;
      transition: color 0.2s ease, border-color 0.2s ease;
      outline: none;
      font-family: inherit;
      margin-bottom: -1px;
    }

    .tab:hover {
      color: var(--text);
    }

    .tab.active {
      color: var(--accent);
      border-bottom-color: var(--accent);
    }

    /* íƒ­ ì½˜í…ì¸  ë˜í¼ - ì „í™˜ ì‹œ ë¶€ë“œëŸ¬ìš´ opacity íŠ¸ëœì§€ì…˜ */
    .tab-content {
      flex: 1;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      animation: fadeIn 0.2s ease;
    }

    .tab-content.hidden {
      display: none;
    }

    /* â”€â”€ ì±„íŒ… ë·° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .chat-container {
      flex: 1;
      overflow-y: auto;
      padding: 16px 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      scrollbar-width: thin;
      scrollbar-color: var(--border) transparent;
    }

    .chat-container::-webkit-scrollbar { width: 4px; }
    .chat-container::-webkit-scrollbar-track { background: transparent; }
    .chat-container::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

    /* ì±„íŒ… ë¹ˆ ìƒíƒœ */
    .chat-empty {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      flex: 1;
      gap: 10px;
      color: var(--text-muted);
      text-align: center;
      padding: 40px;
    }

    .chat-empty .empty-icon { font-size: 48px; opacity: 0.4; margin-bottom: 4px; }
    .chat-empty .empty-text { font-size: 14px; font-weight: 600; color: var(--text-muted); }
    .chat-empty .empty-hint { font-size: 12px; opacity: 0.6; max-width: 280px; line-height: 1.5; }

    /* ì±„íŒ… ë©”ì‹œì§€ ê·¸ë£¹ (íƒ€ì„ìŠ¤íƒ¬í”„ + ë²„ë¸”) - ìŠ¬ë¼ì´ë“œ ì—… ì• ë‹ˆë©”ì´ì…˜ */
    .chat-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
      animation: slideUp 0.3s ease;
    }

    .chat-timestamp {
      font-size: 10px;
      color: var(--text-muted);
      font-family: 'Courier New', monospace;
      text-align: center;
      opacity: 0.7;
    }

    /* ì±„íŒ… ë²„ë¸” */
    .chat-bubble {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      max-width: 85%;
    }

    /* ì‚¬ìš©ì ë©”ì‹œì§€: ì˜¤ë¥¸ìª½ ì •ë ¬ */
    .chat-bubble.user-msg {
      align-self: flex-end;
      flex-direction: row-reverse;
    }

    .bubble-avatar {
      font-size: 18px;
      flex-shrink: 0;
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      background: rgba(255,255,255,0.04);
      border: 1px solid var(--border);
    }

    .bubble-content {
      flex: 1;
      min-width: 0;
    }

    .bubble-header {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 4px;
    }

    .bubble-name {
      font-size: 11px;
      font-weight: 700;
      color: var(--text);
    }

    .bubble-layer {
      font-size: 9px;
      color: var(--text-muted);
      background: rgba(255,255,255,0.05);
      border-radius: 8px;
      padding: 1px 6px;
    }

    .bubble-text {
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 12px;
      line-height: 1.5;
      word-break: break-word;
    }

    /* ë ˆì´ì–´ë³„ ë²„ë¸” ë°°ê²½ìƒ‰ */
    .bubble-text.layer-Orchestration { background: #1a365d; border: 1px solid rgba(88,132,255,0.25); }
    .bubble-text.layer-Execution     { background: #1a3a2a; border: 1px solid rgba(63,185,80,0.25); }
    .bubble-text.layer-Specialist    { background: #3a2a1a; border: 1px solid rgba(249,115,22,0.25); }
    .bubble-text.layer-Advisory      { background: #2a1a3a; border: 1px solid rgba(168,85,247,0.25); }
    .bubble-text.layer-Utility       { background: #1a2a2a; border: 1px solid rgba(20,184,166,0.25); }
    .bubble-text.layer-user          { background: #1e2a1a; border: 1px solid rgba(63,185,80,0.35); }

    /* ì‚¬ìš©ì ë©”ì‹œì§€ ë²„ë¸” í—¤ë” ìš°ì¸¡ ì •ë ¬ */
    .chat-bubble.user-msg .bubble-header {
      flex-direction: row-reverse;
    }

    /* ìœ„ì„ ë²„ë¸”: ì ì„  ë³´ë” */
    .bubble-text.delegation-bubble {
      background: rgba(88,166,255,0.06) !important;
      border: 1px dashed rgba(88,166,255,0.4) !important;
    }

    .delegation-bubble-inner {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }

    .delegation-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: rgba(88,166,255,0.15);
      border-radius: 10px;
      padding: 1px 8px;
      font-size: 11px;
      font-weight: 600;
      color: var(--accent);
    }

    .delegation-task-text {
      font-size: 11px;
      color: var(--text-muted);
      font-style: italic;
      margin-top: 4px;
    }

    /* â”€â”€ Debate ë·° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .debate-container {
      flex: 1;
      overflow-y: auto;
      padding: 16px 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      scrollbar-width: thin;
      scrollbar-color: var(--border) transparent;
    }

    .debate-container::-webkit-scrollbar { width: 4px; }
    .debate-container::-webkit-scrollbar-track { background: transparent; }
    .debate-container::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

    /* Debate ë¹ˆ ìƒíƒœ */
    .debate-empty {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      flex: 1;
      gap: 10px;
      color: var(--text-muted);
      text-align: center;
      padding: 40px;
    }

    .debate-empty .empty-icon { font-size: 48px; opacity: 0.4; margin-bottom: 4px; }
    .debate-empty .empty-text { font-size: 14px; font-weight: 600; color: var(--text-muted); }
    .debate-empty .empty-hint { font-size: 12px; opacity: 0.6; max-width: 280px; line-height: 1.5; }

    /* Debate í—¤ë” */
    .debate-header {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 14px 16px;
      display: flex;
      align-items: center;
      gap: 10px;
      flex-shrink: 0;
    }

    .debate-header-emoji {
      font-size: 22px;
    }

    .debate-header-info {
      flex: 1;
    }

    .debate-label {
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      color: var(--text-muted);
      margin-bottom: 2px;
    }

    .debate-topic {
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
    }

    .debate-status-badge {
      padding: 3px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }

    .debate-status-badge.active {
      background: rgba(88,166,255,0.15);
      border: 1px solid rgba(88,166,255,0.35);
      color: var(--accent);
    }

    .debate-status-badge.concluded {
      background: rgba(63,185,80,0.15);
      border: 1px solid rgba(63,185,80,0.35);
      color: var(--success);
    }

    /* Debate ë¼ìš´ë“œ */
    .debate-round {
      display: flex;
      flex-direction: column;
      gap: 10px;
      animation: fadeIn 0.4s ease;
    }

    .debate-round-label {
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .debate-round-label::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--border);
    }

    /* íŒ¨ë„ë¦¬ìŠ¤íŠ¸ ì¹´ë“œ í–‰ */
    .debate-panelists {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .panelist-card {
      flex: 1;
      min-width: 160px;
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px;
      animation: fadeIn 0.35s ease;
    }

    .panelist-header {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 8px;
    }

    .panelist-emoji {
      font-size: 18px;
    }

    .panelist-name {
      font-size: 12px;
      font-weight: 700;
      color: var(--text);
    }

    .panelist-opinion {
      font-size: 12px;
      color: var(--text-muted);
      line-height: 1.5;
      word-break: break-word;
    }

    /* Debate ê²°ë¡  ì¹´ë“œ */
    .debate-conclusion {
      background: rgba(63,185,80,0.05);
      border: 1px solid rgba(63,185,80,0.35);
      border-radius: 10px;
      padding: 14px 16px;
      animation: fadeIn 0.4s ease;
    }

    .debate-conclusion-label {
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      color: var(--success);
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .debate-conclusion-text {
      font-size: 13px;
      color: var(--text);
      line-height: 1.6;
    }

    /* â”€â”€ ë°˜ì‘í˜• (ìµœì†Œ 800px) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    @media (max-width: 960px) {
      :root { --sidebar-w: 56px; }

      .agent-info,
      .agent-status,
      .layer-label { display: none; }

      .agent-card   { justify-content: center; padding: 8px 4px; }
      .agent-emoji  { font-size: 22px; width: auto; }

      .stage-text   { display: none; }
      .stage-inner  { justify-content: center; padding: 6px; }
    }

    @media (max-width: 800px) {
      .app {
        grid-template-columns: 1fr;
        grid-template-rows: var(--header-h) auto 1fr var(--footer-h);
        grid-template-areas:
          "header"
          "sidebar"
          "main"
          "footer";
      }

      .sidebar {
        display: flex;
        flex-direction: row;
        overflow-x: auto;
        overflow-y: hidden;
        height: auto;
        padding: 6px 8px;
        border-right: none;
        border-bottom: 1px solid var(--border);
      }

      .layer-group  { display: flex; flex-direction: row; margin-bottom: 0; gap: 4px; }
      .layer-label  { display: none; }
      .agent-info, .agent-status { display: none; }
      .agent-card   { padding: 6px; }
    }

    /* â”€â”€ 768px ë¯¸ë§Œ: íƒ­ ì´ë¦„ ì¶•ì•½ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    @media (max-width: 768px) {
      /* íƒ­ ì´ë¦„ ì¶•ì•½ì„ JSë¡œ ì²˜ë¦¬í•˜ê¸° ìœ„í•´ data ì†ì„± ì‚¬ìš© */
      .tab[data-tab="timeline"] .tab-label-short { display: inline; }
      .tab[data-tab="timeline"] .tab-label-full  { display: none; }
      .tab[data-tab="chat"]     .tab-label-short { display: inline; }
      .tab[data-tab="chat"]     .tab-label-full  { display: none; }
      .tab[data-tab="debate"]   .tab-label-short { display: inline; }
      .tab[data-tab="debate"]   .tab-label-full  { display: none; }

      /* íƒ­ íŒ¨ë”© ì¶•ì†Œ */
      .tab { padding: 10px 10px; font-size: 11px; }

      /* í—¤ë” ë¸Œëœë“œ ì¶•ì†Œ */
      .header-brand h1 { font-size: 14px; }
      .header-brand .subtitle { display: none; }
    }

    /* 768px ì´ìƒ: ì „ì²´ ì´ë¦„ í‘œì‹œ, ì¶•ì•½ ì´ë¦„ ìˆ¨ê¹€ */
    @media (min-width: 769px) {
      .tab-label-short { display: none; }
      .tab-label-full  { display: inline; }
    }
  </style>
</head>
<body>

<!-- â”€â”€ ì—°ê²° ëŠê¹€ ì•Œë¦¼ ë°” (ìƒë‹¨ ìŠ¬ë¼ì´ë“œ ë‹¤ìš´) â”€â”€ -->
<div class="conn-alert-bar" id="conn-alert-bar" role="alert" aria-live="assertive">
  <span id="conn-alert-icon">âš ï¸</span>
  <span id="conn-alert-text">ëŒ€ì‹œë³´ë“œ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤. ìë™ ì¬ì—°ê²° ì¤‘...</span>
</div>

<div class="app">

  <!-- â”€â”€ í—¤ë” â”€â”€ -->
  <header class="header">
    <div class="header-brand">
      <div class="logo">ğŸ‘¦</div>
      <div>
        <h1>Team-Shinchan Dashboard</h1>
        <div class="subtitle">Multi-Agent Workflow Monitor</div>
      </div>
    </div>

    <div class="conn-badge disconnected" id="conn-badge" aria-label="ì—°ê²° ìƒíƒœ: ì—°ê²° ëŠê¹€" role="status">
      <div class="conn-dot"></div>
      <span id="conn-label">Disconnected</span>
    </div>
  </header>

  <!-- â”€â”€ ì‚¬ì´ë“œë°” (ì—ì´ì „íŠ¸ ëª©ë¡) â”€â”€ -->
  <aside class="sidebar" id="sidebar">
    <!-- JSê°€ ë Œë”ë§ -->
  </aside>

  <!-- â”€â”€ ë©”ì¸ â”€â”€ -->
  <main class="main">

    <!-- ì›Œí¬í”Œë¡œìš° í”„ë¡œê·¸ë ˆìŠ¤ ë°” -->
    <div class="workflow-bar">
      <div class="workflow-title">
        Workflow Stage
        <span class="phase-info" id="phase-info" style="display:none"></span>
      </div>
      <div class="stages" id="stages">
        <!-- JSê°€ ë Œë”ë§ -->
      </div>
    </div>

    <!-- Phase ì§„í–‰ë¥  ì„¹ì…˜ (phase ì •ë³´ ìˆì„ ë•Œë§Œ í‘œì‹œ) -->
    <div class="phase-progress-bar" id="phase-progress-bar" aria-label="Phase ì§„í–‰ë¥ ">
      <div class="phase-progress-header">
        <div class="phase-progress-label">Phase Progress</div>
        <div class="phase-progress-counter" id="phase-counter"></div>
      </div>
      <div class="phase-progress-title" id="phase-title" style="display:none"></div>
      <div class="phase-dots" id="phase-dots" role="list" aria-label="Phase ëª©ë¡"></div>
    </div>

    <!-- ìœ„ì„ íë¦„ ì‹œê°í™” ì„¹ì…˜ (ìœ„ì„ ì—†ìœ¼ë©´ ìˆ¨ê¹€) -->
    <div class="delegation-section" id="delegation-section">
      <div class="delegation-section-title">í˜„ì¬ ìœ„ì„ íë¦„</div>
      <div class="delegation-chain" id="delegation-chain">
        <!-- JSê°€ ë™ì ìœ¼ë¡œ ë Œë”ë§ -->
      </div>
    </div>

    <!-- íƒ­ ë°” -->
    <div class="tab-bar" role="tablist" aria-label="ë·° ì„ íƒ">
      <button class="tab active" data-tab="timeline" role="tab" aria-selected="true" aria-controls="tab-timeline" title="í™œë™ íƒ€ì„ë¼ì¸">
        <span class="tab-label-full">íƒ€ì„ë¼ì¸</span>
        <span class="tab-label-short">ğŸ“¡</span>
      </button>
      <button class="tab" data-tab="chat" role="tab" aria-selected="false" aria-controls="tab-chat" title="ì—ì´ì „íŠ¸ ëŒ€í™”">
        <span class="tab-label-full">ëŒ€í™”</span>
        <span class="tab-label-short">ğŸ’¬</span>
      </button>
      <button class="tab" data-tab="debate" role="tab" aria-selected="false" aria-controls="tab-debate" title="í† ë¡ ">
        <span class="tab-label-full">í† ë¡ </span>
        <span class="tab-label-short">ğŸŒ»</span>
      </button>
    </div>

    <!-- íƒ­ 1: íƒ€ì„ë¼ì¸ -->
    <div class="tab-content" id="tab-timeline" role="tabpanel" aria-labelledby="tab-timeline-btn">
      <!-- í™œë™ íƒ€ì„ë¼ì¸ -->
      <div class="timeline-section">
        <div class="timeline-header">
          <div class="timeline-title">Activity Timeline</div>
          <div class="event-count" id="event-count" aria-live="polite">0 events</div>
        </div>
        <div class="timeline" id="timeline" role="log" aria-label="í™œë™ ì´ë²¤íŠ¸ ëª©ë¡" aria-live="polite">
          <div class="timeline-empty" id="timeline-empty">
            <div class="empty-icon">ğŸ“¡</div>
            <div class="empty-text">ì•„ì§ í™œë™ì´ ì—†ìŠµë‹ˆë‹¤</div>
            <div class="empty-hint">ì›Œí¬í”Œë¡œìš°ë¥¼ ì‹œì‘í•˜ë©´ ì—¬ê¸°ì— í™œë™ì´ í‘œì‹œë©ë‹ˆë‹¤</div>
          </div>
        </div>
      </div>
    </div>

    <!-- íƒ­ 2: ì±„íŒ… (ëŒ€í™”) -->
    <div class="tab-content hidden" id="tab-chat" role="tabpanel" aria-labelledby="tab-chat-btn">
      <div class="chat-container" id="chat-container" role="log" aria-label="ì—ì´ì „íŠ¸ ëŒ€í™”" aria-live="polite">
        <div class="chat-empty" id="chat-empty">
          <div class="empty-icon">ğŸ’¬</div>
          <div class="empty-text">ì—ì´ì „íŠ¸ ëŒ€í™”ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</div>
          <div class="empty-hint">ì—ì´ì „íŠ¸ê°€ ì‘ì—…ì„ ì‹œì‘í•˜ë©´ ëŒ€í™” ë‚´ìš©ì´ í‘œì‹œë©ë‹ˆë‹¤</div>
        </div>
      </div>
    </div>

    <!-- íƒ­ 3: í† ë¡  (Debate) -->
    <div class="tab-content hidden" id="tab-debate" role="tabpanel" aria-labelledby="tab-debate-btn">
      <div class="debate-container" id="debate-container">
        <div class="debate-empty" id="debate-empty">
          <div class="empty-icon">ğŸŒ»</div>
          <div class="empty-text">ì§„í–‰ ì¤‘ì¸ í† ë¡ ì´ ì—†ìŠµë‹ˆë‹¤</div>
          <div class="empty-hint">ì—ì´ì „íŠ¸ ê°„ í† ë¡ ì´ ì‹œì‘ë˜ë©´ ì´ íƒ­ì´ ìë™ìœ¼ë¡œ í™œì„±í™”ë©ë‹ˆë‹¤</div>
        </div>
      </div>
    </div>

  </main>

  <!-- â”€â”€ í‘¸í„° â”€â”€ -->
  <footer class="footer">
    <div class="footer-left">
      <div class="footer-item">
        <span>Endpoint</span>
        <span id="footer-endpoint">â€”</span>
      </div>
      <div class="footer-item">
        <span>Stream</span>
        <span id="footer-stream">/api/events/stream</span>
      </div>
    </div>
    <div class="footer-right">
      <div class="footer-item">
        <span>Agents</span>
        <span>15</span>
      </div>
      <div class="footer-item">
        <span>Version</span>
        <span>1.0.0</span>
      </div>
      <div class="footer-item">
        <span id="footer-clock">â€”</span>
      </div>
    </div>
  </footer>

</div><!-- /.app -->

<script>
  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ì—ì´ì „íŠ¸ ì •ì  ë°ì´í„°
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  const AGENTS = {
    shinnosuke:  { emoji: 'ğŸ‘¦', name: 'Shinnosuke',   role: 'Orchestrator',    layer: 'Orchestration', model: 'opus' },
    himawari:    { emoji: 'ğŸŒ¸', name: 'Himawari',     role: 'Atlas',           layer: 'Orchestration', model: 'opus' },
    midori:      { emoji: 'ğŸŒ»', name: 'Midori',       role: 'Debate Moderator',layer: 'Orchestration', model: 'sonnet' },
    bo:          { emoji: 'ğŸ˜ª', name: 'Bo',           role: 'Task Executor',   layer: 'Execution',     model: 'sonnet' },
    kazama:      { emoji: 'ğŸ©', name: 'Kazama',       role: 'Deep Worker',     layer: 'Execution',     model: 'opus' },
    aichan:      { emoji: 'ğŸ€', name: 'Aichan',       role: 'Frontend',        layer: 'Specialist',    model: 'sonnet' },
    bunta:       { emoji: 'ğŸœ', name: 'Bunta',        role: 'Backend',         layer: 'Specialist',    model: 'sonnet' },
    masao:       { emoji: 'ğŸ™', name: 'Masao',        role: 'DevOps',          layer: 'Specialist',    model: 'sonnet' },
    hiroshi:     { emoji: 'ğŸ‘”', name: 'Hiroshi',      role: 'Oracle',          layer: 'Advisory',      model: 'opus' },
    nene:        { emoji: 'ğŸ“‹', name: 'Nene',         role: 'Planner',         layer: 'Advisory',      model: 'opus' },
    misae:       { emoji: 'ğŸ‘©', name: 'Misae',        role: 'Pre-Planning',    layer: 'Advisory',      model: 'sonnet' },
    actionkamen: { emoji: 'ğŸ¦¸', name: 'Action Kamen', role: 'Reviewer',        layer: 'Advisory',      model: 'opus' },
    shiro:       { emoji: 'ğŸ¶', name: 'Shiro',        role: 'Explorer',        layer: 'Utility',       model: 'haiku' },
    masumi:      { emoji: 'ğŸ“š', name: 'Masumi',       role: 'Librarian',       layer: 'Utility',       model: 'sonnet' },
    ume:         { emoji: 'ğŸ–¼ï¸', name: 'Ume',          role: 'Multimodal',      layer: 'Utility',       model: 'sonnet' },
  };

  /* ë ˆì´ì–´ ìˆœì„œ ì •ì˜ */
  const LAYER_ORDER = ['Orchestration', 'Execution', 'Specialist', 'Advisory', 'Utility'];

  /* ì›Œí¬í”Œë¡œìš° 4-ìŠ¤í…Œì´ì§€ ì •ì˜ */
  const STAGES = [
    { id: 'requirements', label: 'Requirements', num: 1 },
    { id: 'planning',     label: 'Planning',     num: 2 },
    { id: 'execution',    label: 'Execution',    num: 3 },
    { id: 'completion',   label: 'Completion',   num: 4 },
  ];

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ì• í”Œë¦¬ì¼€ì´ì…˜ ìƒíƒœ
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  const state = {
    connected:         false,
    currentStage:      null,    /* í˜„ì¬ ì›Œí¬í”Œë¡œìš° ìŠ¤í…Œì´ì§€ ID */
    currentPhase:      null,    /* "1/4" í˜•íƒœ */
    currentPhaseTitle: null,    /* Phase ì œëª© (ì„ íƒì ) */
    agentStatuses:    {},      /* { agentId: 'idle'|'working'|'completed' } */
    events:           [],      /* ì´ë²¤íŠ¸ ëª©ë¡ (ìµœì‹ ìˆœ) */
    eventSource:      null,
    delegationChain:  [],      /* í˜„ì¬ ìœ„ì„ ì²´ì¸ [agentId, agentId, ...] */
    activeAgentId:    null,    /* í˜„ì¬ ì‘ì—… ì¤‘ì¸ ì—ì´ì „íŠ¸ ID */
    MAX_EVENTS:       100,     /* DOMì— ìœ ì§€í•  ìµœëŒ€ ì´ë²¤íŠ¸ ìˆ˜ */
    /* â”€â”€ ì±„íŒ… ìƒíƒœ â”€â”€ */
    chatMessages:     [],      /* ì±„íŒ… ë©”ì‹œì§€ ëª©ë¡ */
    MAX_CHAT:         200,     /* ìµœëŒ€ ì±„íŒ… ë©”ì‹œì§€ ìˆ˜ */
    /* â”€â”€ Debate ìƒíƒœ â”€â”€ */
    debateState:      'inactive', /* inactive | active | concluded */
    debateTopic:      null,
    debateRounds:     [],      /* [{ label, panelists: [{ agentId, opinion }] }] */
    debateConclusion: null,
    currentRoundIdx:  -1,
  };

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ì´ˆê¸°í™”
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  function init() {
    renderSidebar();
    renderStages();
    startClock();
    updateFooterEndpoint();
    initTabs();
    loadInitialData();
    connectSSE();
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     íƒ­ ì‹œìŠ¤í…œ
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

  /* íƒ­ ì´ˆê¸°í™”: í´ë¦­ ì´ë²¤íŠ¸ ë“±ë¡ */
  function initTabs() {
    const tabs = document.querySelectorAll('.tab-bar .tab');
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        const tabId = tab.dataset.tab;
        switchTab(tabId);
      });
    });
  }

  /* íƒ­ ì „í™˜ í•¨ìˆ˜ */
  function switchTab(tabId) {
    /* íƒ­ ë²„íŠ¼ í™œì„± ìƒíƒœ ë° aria-selected ë³€ê²½ */
    const tabs = document.querySelectorAll('.tab-bar .tab');
    tabs.forEach(tab => {
      const isActive = tab.dataset.tab === tabId;
      tab.classList.toggle('active', isActive);
      tab.setAttribute('aria-selected', isActive ? 'true' : 'false');
    });

    /* íƒ­ ì½˜í…ì¸  í‘œì‹œ/ìˆ¨ê¹€ - hidden ì œê±° ì‹œ fadeIn ì• ë‹ˆë©”ì´ì…˜ ì¬ì‹¤í–‰ */
    const contents = document.querySelectorAll('.tab-content');
    contents.forEach(content => {
      const isVisible = content.id === `tab-${tabId}`;
      if (isVisible && content.classList.contains('hidden')) {
        /* hidden ì œê±° í›„ ì• ë‹ˆë©”ì´ì…˜ ì¬ì‹¤í–‰ì„ ìœ„í•´ reflow ê°•ì œ */
        content.classList.remove('hidden');
        void content.offsetWidth; /* reflow trigger */
      } else if (!isVisible) {
        content.classList.add('hidden');
      }
    });
  }

  /* â”€â”€ ì‹œê³„ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function startClock() {
    const el = document.getElementById('footer-clock');
    function tick() {
      const now = new Date();
      el.textContent = now.toLocaleTimeString('ko-KR', { hour12: false });
    }
    tick();
    setInterval(tick, 1000);
  }

  /* â”€â”€ í‘¸í„° ì—”ë“œí¬ì¸íŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function updateFooterEndpoint() {
    const el = document.getElementById('footer-endpoint');
    el.textContent = window.location.host || 'localhost';
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ì‚¬ì´ë“œë°” ë Œë”ë§
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  function renderSidebar() {
    const sidebar = document.getElementById('sidebar');
    sidebar.innerHTML = '';

    /* ë ˆì´ì–´ë³„ ê·¸ë£¹í™” */
    const byLayer = {};
    LAYER_ORDER.forEach(l => (byLayer[l] = []));
    Object.entries(AGENTS).forEach(([id, ag]) => {
      if (byLayer[ag.layer]) byLayer[ag.layer].push({ id, ...ag });
    });

    LAYER_ORDER.forEach(layer => {
      const agents = byLayer[layer];
      if (!agents.length) return;

      const group = document.createElement('div');
      group.className = 'layer-group';

      const label = document.createElement('div');
      label.className = 'layer-label';
      label.textContent = layer;
      group.appendChild(label);

      agents.forEach(ag => {
        const card = document.createElement('div');
        card.className = 'agent-card';
        card.id = `agent-${ag.id}`;
        card.dataset.status = state.agentStatuses[ag.id] || 'idle';
        card.title = `${ag.name} (${ag.role}) â€” ${ag.model}`;

        card.innerHTML = `
          <div class="agent-emoji">${ag.emoji}</div>
          <div class="agent-info">
            <div class="agent-name">${ag.name}</div>
            <div class="agent-role">${ag.role}</div>
            <div class="agent-preview" id="preview-${ag.id}"></div>
          </div>
          <div class="agent-status"></div>
          <div class="agent-check" id="check-${ag.id}">âœ“</div>
        `;
        group.appendChild(card);
      });

      sidebar.appendChild(group);
    });
  }

  /* ì—ì´ì „íŠ¸ ìƒíƒœ ì—…ë°ì´íŠ¸ */
  function updateAgentStatus(agentId, status, previewMsg) {
    state.agentStatuses[agentId] = status;
    const card = document.getElementById(`agent-${agentId}`);
    if (!card) return;

    card.dataset.status = status;

    /* agent_start: ì‘ì—… ì‹œì‘ â†’ ìƒíƒœ í…ìŠ¤íŠ¸ í‘œì‹œ */
    const roleEl = card.querySelector('.agent-role');
    if (roleEl) {
      if (status === 'working') {
        roleEl.textContent = 'Working...';
        state.activeAgentId = agentId;
      } else {
        /* idle / completed ì‹œ ì›ë˜ role ë³µì› */
        const agentData = AGENTS[agentId];
        if (agentData) roleEl.textContent = agentData.role;
        if (status !== 'working' && state.activeAgentId === agentId) {
          state.activeAgentId = null;
        }
      }
    }

    /* ë©”ì‹œì§€ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸ */
    if (previewMsg) {
      const previewEl = document.getElementById(`preview-${agentId}`);
      if (previewEl) {
        previewEl.textContent = previewMsg;
        previewEl.classList.add('visible');
      }
    }

    /* agent_done: ì²´í¬ë§ˆí¬ 2ì´ˆ í›„ idle ì „í™˜ */
    if (status === 'completed') {
      const checkEl = document.getElementById(`check-${agentId}`);
      if (checkEl) {
        checkEl.classList.add('show');
        setTimeout(() => {
          checkEl.classList.remove('show');
          card.dataset.status = 'idle';
          state.agentStatuses[agentId] = 'idle';
          /* idle ì „í™˜ ì‹œ role ë³µì› */
          const agentData = AGENTS[agentId];
          if (agentData && roleEl) roleEl.textContent = agentData.role;
        }, 2000);
      }
    }
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ì›Œí¬í”Œë¡œìš° ìŠ¤í…Œì´ì§€ ë Œë”ë§
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  function renderStages() {
    const container = document.getElementById('stages');
    container.innerHTML = '';

    const currentIdx = STAGES.findIndex(s => s.id === state.currentStage);

    STAGES.forEach((stage, idx) => {
      /* ìŠ¤í…Œì´ì§€ ìƒíƒœ ê²°ì • */
      let stageState = 'pending';
      if (state.currentStage === null) {
        stageState = 'pending';
      } else if (idx < currentIdx) {
        stageState = 'done';
      } else if (idx === currentIdx) {
        stageState = 'active';
      }

      /* ì—°ê²°ì„  (ì²« ìŠ¤í…Œì´ì§€ ì œì™¸) */
      if (idx > 0) {
        const conn = document.createElement('div');
        conn.className = `stage-connector${idx <= currentIdx && currentIdx > 0 ? ' done' : ''}`;
        container.appendChild(conn);
      }

      /* ìŠ¤í…Œì´ì§€ ì•„ì´í…œ */
      const stageEl = document.createElement('div');
      stageEl.className = `stage ${stageState}`;
      stageEl.innerHTML = `
        <div class="stage-inner">
          <div class="stage-icon">
            ${stageState === 'done'
              ? 'âœ“'
              : stageState === 'active'
                ? stage.num
                : stage.num}
          </div>
          <div class="stage-text">
            <div class="stage-num">Stage ${stage.num}</div>
            <div class="stage-name">${stage.label}</div>
          </div>
        </div>
      `;
      container.appendChild(stageEl);
    });
  }

  /* ìŠ¤í…Œì´ì§€ + í˜ì´ì¦ˆ ì—…ë°ì´íŠ¸ */
  function updateWorkflow(stageId, phase, phaseTitle) {
    state.currentStage      = stageId || null;
    state.currentPhase      = phase || null;
    state.currentPhaseTitle = phaseTitle || null;

    renderStages();

    /* ì›Œí¬í”Œë¡œìš° ë°”ì˜ phase-info ë°°ì§€ ì—…ë°ì´íŠ¸ */
    const phaseEl = document.getElementById('phase-info');
    if (phase) {
      phaseEl.textContent = `Phase ${phase}`;
      phaseEl.style.display = '';
    } else {
      phaseEl.style.display = 'none';
    }

    /* Phase ì§„í–‰ë¥  ì„¹ì…˜ ë Œë”ë§ */
    renderPhaseProgress(phase, phaseTitle);
  }

  /* Phase ì§„í–‰ë¥  ë„íŠ¸ ë Œë”ë§
     phase í˜•íƒœ: "2/4" (í˜„ì¬/ì „ì²´) */
  function renderPhaseProgress(phase, phaseTitle) {
    const bar = document.getElementById('phase-progress-bar');

    if (!phase) {
      bar.classList.remove('visible');
      return;
    }

    /* "2/4" í˜•íƒœ íŒŒì‹± */
    const parts   = String(phase).split('/');
    const current = parseInt(parts[0], 10) || 1;
    const total   = parseInt(parts[1], 10) || 4;

    /* Phase ì¹´ìš´í„° í…ìŠ¤íŠ¸ */
    document.getElementById('phase-counter').textContent = `Phase ${current} / ${total}`;

    /* Phase ì œëª© í‘œì‹œ */
    const titleEl = document.getElementById('phase-title');
    if (phaseTitle) {
      titleEl.textContent = phaseTitle;
      titleEl.style.display = '';
    } else {
      titleEl.style.display = 'none';
    }

    /* Phase ë„íŠ¸ ìƒì„± */
    const dotsEl = document.getElementById('phase-dots');
    dotsEl.innerHTML = '';

    for (let i = 1; i <= total; i++) {
      const dot = document.createElement('div');
      dot.className = 'phase-dot';
      dot.setAttribute('role', 'listitem');

      if (i < current) {
        dot.classList.add('done');
        dot.title = `Phase ${i} - ì™„ë£Œ`;
        dot.setAttribute('aria-label', `Phase ${i} ì™„ë£Œ`);
      } else if (i === current) {
        dot.classList.add('current');
        dot.title = `Phase ${i} - ì§„í–‰ ì¤‘${phaseTitle ? ': ' + phaseTitle : ''}`;
        dot.setAttribute('aria-label', `Phase ${i} ì§„í–‰ ì¤‘`);
      } else {
        dot.classList.add('future');
        dot.title = `Phase ${i} - ëŒ€ê¸°`;
        dot.setAttribute('aria-label', `Phase ${i} ëŒ€ê¸°`);
      }

      dotsEl.appendChild(dot);
    }

    bar.classList.add('visible');
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     íƒ€ì„ë¼ì¸ (ì´ë²¤íŠ¸ ë¡œê·¸)
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

  /* ì‹œê°„ í¬ë§·: HH:MM:SS */
  function formatTime(date) {
    const d = date instanceof Date ? date : new Date(date);
    const pad = n => String(n).padStart(2, '0');
    return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
  }

  /* SSE ì´ë²¤íŠ¸ ì¢…ë¥˜ë³„ ì•„ì´ì½˜ ë°˜í™˜ */
  function getEventIcon(etype) {
    const icons = {
      agent_start:     'ğŸŸ¢',
      agent_done:      'ğŸ”´',
      delegation:      'â¡ï¸',
      message:         'ğŸ’¬',
      user_prompt:     'ğŸ‘¤',
      tool_use:        'ğŸ”§',
      stop:            'â¹ï¸',
      session_start:   'ğŸš€',
      session_end:     'ğŸ',
      workflow_update: 'ğŸ“‹',
    };
    return icons[etype] || null; /* nullì´ë©´ ì—ì´ì „íŠ¸ ì´ëª¨ì§€ ì‚¬ìš© */
  }

  /* delegation ì´ë²¤íŠ¸ ì „ìš© HTML ìƒì„± */
  function buildDelegationHtml(data) {
    const fromAgent = AGENTS[data.from] || { emoji: 'ğŸ¤–', name: data.from || '?' };
    const toAgent   = AGENTS[data.to]   || { emoji: 'ğŸ¤–', name: data.to   || '?' };
    return `
      <div class="event-delegation">
        <span class="delegation-from">${fromAgent.emoji} ${escapeHtml(fromAgent.name)}</span>
        <span class="delegation-arrow">â†’</span>
        <span class="delegation-to">${toAgent.emoji} ${escapeHtml(toAgent.name)}</span>
        ${data.task ? `<div class="delegation-task">"${escapeHtml(data.task)}"</div>` : ''}
      </div>
    `;
  }

  /* ì´ë²¤íŠ¸ ì¶”ê°€ (ìµœì‹  ì´ë²¤íŠ¸ê°€ ìƒë‹¨)
     data í˜•íƒœ: { agentId, message, type, etype, timestamp, from, to, task, ... } */
  function addTimelineEvent(data) {
    const {
      agentId,
      message,
      type      = 'info',
      etype     = null,   /* SSE ì´ë²¤íŠ¸ ì¢…ë¥˜ (agent_start, delegation ë“±) */
      timestamp = new Date(),
      from,
      to,
      task,
    } = data;

    const agent     = AGENTS[agentId] || { emoji: 'ğŸ¤–', name: agentId || 'System' };
    const icon      = getEventIcon(etype) || agent.emoji;
    const agentName = agent.name;

    /* ë¹ˆ ìƒíƒœ ìˆ¨ê¹€ */
    const emptyEl = document.getElementById('timeline-empty');
    if (emptyEl) emptyEl.style.display = 'none';

    /* ì´ë²¤íŠ¸ ì•„ì´í…œ ìƒì„± */
    const item = document.createElement('div');
    item.className = 'event-item';

    /* ì´ë²¤íŠ¸ íƒ€ì… ì†ì„± ì„¤ì • */
    if (etype) item.dataset.etype = etype;
    else       item.dataset.type  = type;

    /* delegation ì´ë²¤íŠ¸ëŠ” íŠ¹ë³„ ë Œë”ë§ */
    let bodyHtml;
    if (etype === 'delegation' && (from || to)) {
      bodyHtml = buildDelegationHtml({ from, to, task });
    } else {
      bodyHtml = `
        <div class="event-agent">${escapeHtml(agentName)}</div>
        ${message ? `<div class="event-msg">${escapeHtml(message)}</div>` : ''}
      `;
    }

    item.innerHTML = `
      <div class="event-time">${formatTime(timestamp)}</div>
      <div class="event-emoji">${icon}</div>
      <div class="event-body">${bodyHtml}</div>
    `;

    /* íƒ€ì„ë¼ì¸ ìµœìƒë‹¨ì— ì‚½ì… (ìµœì‹ ìˆœ) */
    const timeline = document.getElementById('timeline');
    timeline.insertBefore(item, timeline.firstChild);

    /* ì´ë²¤íŠ¸ ë°°ì—´ ì—…ë°ì´íŠ¸ */
    state.events.unshift(data);

    /* ìµœëŒ€ 100ê°œ ì´ìƒì´ë©´ ì˜¤ë˜ëœ DOM ìš”ì†Œ ì œê±° */
    if (state.events.length > state.MAX_EVENTS) {
      state.events.splice(state.MAX_EVENTS);
      /* DOMì—ì„œ ë§ˆì§€ë§‰ í•­ëª© ì œê±° (emptyEl ì´í›„ì˜ ë§ˆì§€ë§‰ event-item) */
      const items = timeline.querySelectorAll('.event-item');
      if (items.length > state.MAX_EVENTS) {
        items[items.length - 1].remove();
      }
    }

    /* ì´ë²¤íŠ¸ ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸ */
    const countEl = document.getElementById('event-count');
    countEl.textContent = `${state.events.length} event${state.events.length !== 1 ? 's' : ''}`;
  }

  /* í•˜ìœ„ í˜¸í™˜: ê¸°ì¡´ addEvent() ë˜í¼ */
  function addEvent({ agentId, message, type = 'info', timestamp = new Date() }) {
    addTimelineEvent({ agentId, message, type, timestamp });
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ì±„íŒ… ë·°
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

  /* ì±„íŒ… ë©”ì‹œì§€ ì¶”ê°€
     data í˜•íƒœ: { agentId, message, etype, from, to, task, timestamp, isUser } */
  function addChatMessage(data) {
    const {
      agentId,
      message,
      etype     = null,
      from,
      to,
      task,
      timestamp = new Date(),
      isUser    = false,
    } = data;

    /* ì±„íŒ… ë¹ˆ ìƒíƒœ ìˆ¨ê¹€ */
    const emptyEl = document.getElementById('chat-empty');
    if (emptyEl) emptyEl.style.display = 'none';

    /* ì±„íŒ… ì»¨í…Œì´ë„ˆ */
    const container = document.getElementById('chat-container');

    /* ìœ„ì„ ë©”ì‹œì§€ ì²˜ë¦¬ */
    if (etype === 'delegation' && (from || to)) {
      _appendDelegationBubble(container, { from, to, task, timestamp });
      return;
    }

    /* ë©”ì‹œì§€ê°€ ì—†ìœ¼ë©´ ì¶”ê°€í•˜ì§€ ì•ŠìŒ */
    if (!message) return;

    /* ì—ì´ì „íŠ¸ ì •ë³´ ì¡°íšŒ */
    const agent = isUser
      ? { emoji: 'ğŸ‘¤', name: 'ì‚¬ìš©ì', layer: 'user' }
      : (AGENTS[agentId] || { emoji: 'ğŸ¤–', name: agentId || 'System', layer: 'Utility' });

    const group = document.createElement('div');
    group.className = 'chat-group';

    /* íƒ€ì„ìŠ¤íƒ¬í”„ */
    const tsEl = document.createElement('div');
    tsEl.className = 'chat-timestamp';
    tsEl.textContent = formatTime(timestamp instanceof Date ? timestamp : new Date(timestamp));
    group.appendChild(tsEl);

    /* ë²„ë¸” ë˜í¼ */
    const bubble = document.createElement('div');
    bubble.className = `chat-bubble${isUser ? ' user-msg' : ''}`;

    /* ì•„ë°”íƒ€ */
    const avatar = document.createElement('div');
    avatar.className = 'bubble-avatar';
    avatar.textContent = agent.emoji;

    /* ë²„ë¸” ë³¸ë¬¸ */
    const content = document.createElement('div');
    content.className = 'bubble-content';

    const header = document.createElement('div');
    header.className = 'bubble-header';
    header.innerHTML = `
      <span class="bubble-name">${escapeHtml(agent.name)}</span>
      <span class="bubble-layer">${escapeHtml(agent.layer)}</span>
    `;

    const text = document.createElement('div');
    text.className = `bubble-text layer-${agent.layer.replace(/\s+/g, '')}`;
    text.textContent = message;

    content.appendChild(header);
    content.appendChild(text);
    bubble.appendChild(avatar);
    bubble.appendChild(content);
    group.appendChild(bubble);

    container.appendChild(group);

    /* ë©”ì‹œì§€ ìƒíƒœ ì €ì¥ */
    state.chatMessages.push(data);
    if (state.chatMessages.length > state.MAX_CHAT) {
      state.chatMessages.shift();
      /* ì˜¤ë˜ëœ DOM ìš”ì†Œ ì œê±° */
      const groups = container.querySelectorAll('.chat-group');
      if (groups.length > state.MAX_CHAT) {
        groups[0].remove();
      }
    }

    /* ìµœì‹  ë©”ì‹œì§€ë¡œ ìë™ ìŠ¤í¬ë¡¤ */
    container.scrollTop = container.scrollHeight;
  }

  /* ìœ„ì„ ë²„ë¸” ë Œë”ë§ */
  function _appendDelegationBubble(container, { from, to, task, timestamp }) {
    const fromAgent = AGENTS[from] || { emoji: 'ğŸ¤–', name: from || '?' };
    const toAgent   = AGENTS[to]   || { emoji: 'ğŸ¤–', name: to   || '?' };

    const group = document.createElement('div');
    group.className = 'chat-group';

    const tsEl = document.createElement('div');
    tsEl.className = 'chat-timestamp';
    tsEl.textContent = formatTime(timestamp instanceof Date ? timestamp : new Date(timestamp));
    group.appendChild(tsEl);

    const bubble = document.createElement('div');
    bubble.className = 'chat-bubble';

    const avatar = document.createElement('div');
    avatar.className = 'bubble-avatar';
    avatar.textContent = fromAgent.emoji;

    const content = document.createElement('div');
    content.className = 'bubble-content';

    const text = document.createElement('div');
    text.className = 'bubble-text delegation-bubble';

    const inner = document.createElement('div');
    inner.className = 'delegation-bubble-inner';
    inner.innerHTML = `
      <span class="delegation-badge">${fromAgent.emoji} ${escapeHtml(fromAgent.name)}</span>
      <span style="color:var(--text-muted);font-size:12px;">â†’</span>
      <span class="delegation-badge">${toAgent.emoji} ${escapeHtml(toAgent.name)}</span>
    `;
    if (task) {
      const taskEl = document.createElement('div');
      taskEl.className = 'delegation-task-text';
      taskEl.textContent = `"${task}"`;
      text.appendChild(inner);
      text.appendChild(taskEl);
    } else {
      text.appendChild(inner);
    }

    content.appendChild(text);
    bubble.appendChild(avatar);
    bubble.appendChild(content);
    group.appendChild(bubble);

    container.appendChild(group);
    container.scrollTop = container.scrollHeight;
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ìœ„ì„ íë¦„ ì‹œê°í™”
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

  /* delegation ì´ë²¤íŠ¸ ìˆ˜ì‹  ì‹œ ì²´ì¸ ì—…ë°ì´íŠ¸ */
  function updateDelegationFlow({ from, to, activeAgentId: activeId }) {
    /* ì²´ì¸ì— fromì´ ì—†ìœ¼ë©´ ì¶”ê°€ */
    if (from && !state.delegationChain.includes(from)) {
      state.delegationChain.push(from);
    }
    /* to ì¶”ê°€ */
    if (to && !state.delegationChain.includes(to)) {
      state.delegationChain.push(to);
    }

    /* í˜„ì¬ í™œì„± ì—ì´ì „íŠ¸ ì—…ë°ì´íŠ¸ */
    if (activeId) state.activeAgentId = activeId;
    else if (to)  state.activeAgentId = to;

    renderDelegationChain();
  }

  /* ìœ„ì„ ì²´ì¸ DOM ë Œë”ë§ */
  function renderDelegationChain() {
    const section = document.getElementById('delegation-section');
    const chain   = document.getElementById('delegation-chain');

    if (!state.delegationChain.length) {
      section.classList.remove('visible');
      return;
    }

    section.classList.add('visible');
    chain.innerHTML = '';

    state.delegationChain.forEach((agentId, idx) => {
      /* í™”ì‚´í‘œ (ì²« í•­ëª© ì œì™¸) */
      if (idx > 0) {
        const arrow = document.createElement('span');
        arrow.className = 'chain-arrow';
        arrow.textContent = 'â†’';
        chain.appendChild(arrow);
      }

      /* ì—ì´ì „íŠ¸ ë…¸ë“œ */
      const agentData = AGENTS[agentId] || { emoji: 'ğŸ¤–', name: agentId };
      const node      = document.createElement('div');
      node.className  = 'chain-node';

      /* í˜„ì¬ ì‘ì—… ì¤‘ì¸ ì—ì´ì „íŠ¸ í•˜ì´ë¼ì´íŠ¸ */
      if (agentId === state.activeAgentId) {
        node.classList.add('active');
      }

      node.innerHTML = `
        <span class="chain-emoji">${agentData.emoji}</span>
        <span class="chain-name">${escapeHtml(agentData.name)}</span>
      `;
      chain.appendChild(node);
    });
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     Debate ì‹œê°í™”
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

  /* Debate ì´ë²¤íŠ¸ ì²˜ë¦¬
     data í˜•íƒœ: {
       debate_type: 'start' | 'opinion' | 'conclude',
       topic:        string,         // debate_type === 'start' ì‹œ í† ë¡  ì£¼ì œ
       agentId:      string,         // debate_type === 'opinion' ì‹œ ë°œì–¸ ì—ì´ì „íŠ¸
       opinion:      string,         // ë°œì–¸ ë‚´ìš©
       round:        number,         // ë¼ìš´ë“œ ë²ˆí˜¸ (1ë¶€í„°)
       conclusion:   string,         // debate_type === 'conclude' ì‹œ ê²°ë¡ 
     }
  */
  function handleDebateEvent(data) {
    const debateType = data.debate_type || data.type;

    if (debateType === 'start') {
      /* ìƒˆ í† ë¡  ì‹œì‘ */
      state.debateState      = 'active';
      state.debateTopic      = data.topic || 'í† ë¡  ì£¼ì œ';
      state.debateRounds     = [];
      state.debateConclusion = null;
      state.currentRoundIdx  = -1;

      renderDebate();

      /* ìë™ìœ¼ë¡œ í† ë¡  íƒ­ ì „í™˜ */
      switchTab('debate');
      return;
    }

    if (debateType === 'opinion') {
      /* ë¼ìš´ë“œ ë²ˆí˜¸ ê²°ì • */
      const roundNum = data.round || 1;
      const roundIdx = roundNum - 1;

      /* ë¼ìš´ë“œê°€ ì—†ìœ¼ë©´ ìƒì„± */
      while (state.debateRounds.length <= roundIdx) {
        state.debateRounds.push({
          label:     `Round ${state.debateRounds.length + 1}`,
          panelists: [],
        });
      }

      state.debateRounds[roundIdx].panelists.push({
        agentId: data.agentId,
        opinion: data.opinion || data.message || '',
      });

      state.currentRoundIdx = roundIdx;
      renderDebate();
      return;
    }

    if (debateType === 'conclude') {
      /* í† ë¡  ê²°ë¡  */
      state.debateState      = 'concluded';
      state.debateConclusion = data.conclusion || data.message || '';
      renderDebate();
      return;
    }
  }

  /* Debate DOM ë Œë”ë§ */
  function renderDebate() {
    const container = document.getElementById('debate-container');
    const emptyEl   = document.getElementById('debate-empty');

    if (state.debateState === 'inactive') {
      if (emptyEl) emptyEl.style.display = '';
      return;
    }

    if (emptyEl) emptyEl.style.display = 'none';

    /* ê¸°ì¡´ ë‚´ìš© ì´ˆê¸°í™” í›„ ì¬ë Œë”ë§ */
    container.innerHTML = '';

    /* Debate í—¤ë” */
    const header = document.createElement('div');
    header.className = 'debate-header';
    const statusBadge = state.debateState === 'concluded'
      ? `<span class="debate-status-badge concluded">ê²°ë¡  ë„ì¶œ</span>`
      : `<span class="debate-status-badge active">ì§„í–‰ ì¤‘</span>`;

    header.innerHTML = `
      <div class="debate-header-emoji">ğŸŒ»</div>
      <div class="debate-header-info">
        <div class="debate-label">Debate</div>
        <div class="debate-topic">${escapeHtml(state.debateTopic || '')}</div>
      </div>
      ${statusBadge}
    `;
    container.appendChild(header);

    /* ë¼ìš´ë“œë³„ íŒ¨ë„ë¦¬ìŠ¤íŠ¸ ì¹´ë“œ */
    state.debateRounds.forEach(round => {
      const roundEl = document.createElement('div');
      roundEl.className = 'debate-round';

      const roundLabel = document.createElement('div');
      roundLabel.className = 'debate-round-label';
      roundLabel.textContent = round.label;
      roundEl.appendChild(roundLabel);

      const panelistsEl = document.createElement('div');
      panelistsEl.className = 'debate-panelists';

      round.panelists.forEach(p => {
        const agentData = AGENTS[p.agentId] || { emoji: 'ğŸ¤–', name: p.agentId || '?' };
        const card = document.createElement('div');
        card.className = 'panelist-card';
        card.innerHTML = `
          <div class="panelist-header">
            <span class="panelist-emoji">${agentData.emoji}</span>
            <span class="panelist-name">${escapeHtml(agentData.name)}</span>
          </div>
          <div class="panelist-opinion">${escapeHtml(p.opinion)}</div>
        `;
        panelistsEl.appendChild(card);
      });

      roundEl.appendChild(panelistsEl);
      container.appendChild(roundEl);
    });

    /* ê²°ë¡  ì¹´ë“œ (concluded ìƒíƒœì¼ ë•Œ) */
    if (state.debateState === 'concluded' && state.debateConclusion) {
      const conclusionEl = document.createElement('div');
      conclusionEl.className = 'debate-conclusion';
      conclusionEl.innerHTML = `
        <div class="debate-conclusion-label">ğŸ† ê²°ë¡ </div>
        <div class="debate-conclusion-text">${escapeHtml(state.debateConclusion)}</div>
      `;
      container.appendChild(conclusionEl);
    }

    /* ìµœí•˜ë‹¨ìœ¼ë¡œ ìŠ¤í¬ë¡¤ */
    container.scrollTop = container.scrollHeight;
  }

  /* HTML ì´ìŠ¤ì¼€ì´í”„ (XSS ë°©ì§€) */
  function escapeHtml(str) {
    return String(str)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ì—°ê²° ìƒíƒœ UI
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

  /* connected: true = ì—°ê²°ë¨, false = ëŠê¹€, 'reconnecting' = ì¬ì—°ê²° ì¤‘ */
  function setConnected(connected) {
    state.connected = connected === true;
    const badge    = document.getElementById('conn-badge');
    const label    = document.getElementById('conn-label');
    const alertBar = document.getElementById('conn-alert-bar');
    const alertTxt = document.getElementById('conn-alert-text');
    const alertIco = document.getElementById('conn-alert-icon');

    if (connected === true) {
      /* ì—°ê²° ì„±ê³µ */
      badge.className = 'conn-badge connected';
      badge.setAttribute('aria-label', 'ì—°ê²° ìƒíƒœ: ì—°ê²°ë¨');
      label.textContent = 'Connected';
      /* ì•Œë¦¼ ë°” ìˆ¨ê¹€ */
      alertBar.classList.remove('visible', 'reconnecting-bar');
    } else if (connected === 'reconnecting') {
      /* ì¬ì—°ê²° ì‹œë„ ì¤‘ */
      badge.className = 'conn-badge reconnecting';
      badge.setAttribute('aria-label', 'ì—°ê²° ìƒíƒœ: ì¬ì—°ê²° ì¤‘');
      label.textContent = 'Reconnecting...';
      /* ì•Œë¦¼ ë°” í‘œì‹œ (ì¬ì—°ê²° ìŠ¤íƒ€ì¼) */
      alertIco.textContent = 'ğŸ”„';
      alertTxt.textContent = 'ëŒ€ì‹œë³´ë“œ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤. ìë™ ì¬ì—°ê²° ì¤‘...';
      alertBar.classList.add('visible', 'reconnecting-bar');
    } else {
      /* ì—°ê²° ëŠê¹€ */
      badge.className = 'conn-badge disconnected';
      badge.setAttribute('aria-label', 'ì—°ê²° ìƒíƒœ: ì—°ê²° ëŠê¹€');
      label.textContent = 'Disconnected';
      /* ì•Œë¦¼ ë°” í‘œì‹œ (ì—ëŸ¬ ìŠ¤íƒ€ì¼) */
      alertIco.textContent = 'âš ï¸';
      alertTxt.textContent = 'ëŒ€ì‹œë³´ë“œ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤. ìë™ ì¬ì—°ê²° ì¤‘...';
      alertBar.classList.remove('reconnecting-bar');
      alertBar.classList.add('visible');
    }
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ì´ˆê¸° ë°ì´í„° ë¡œë“œ (REST API)
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  async function loadInitialData() {
    /* ì›Œí¬í”Œë¡œìš° ìƒíƒœ ë¡œë“œ */
    try {
      const res = await fetch('/api/status');
      if (res.ok) {
        const data = await res.json();
        /*
          M-4: ì‹¤ì œ ì‘ë‹µ í˜•íƒœ:
          {
            workflow: { stage, phase, ... },
            server: { ... }
          }
          í•˜ìœ„ í˜¸í™˜ì„ ìœ„í•´ data.stageë„ ì§€ì›
        */
        const stage      = data.workflow?.stage || data.stage;
        const phase      = data.workflow?.phase || data.phase;
        const phaseTitle = data.workflow?.phase_title || data.phase_title;
        if (stage) updateWorkflow(stage, phase, phaseTitle);
      }
    } catch (_e) {
      /* ì„œë²„ ë¯¸ì—°ê²° ì‹œ ë¬´ì‹œ (ì •ì  ëª¨ë“œ) */
    }

    /* ì—ì´ì „íŠ¸ ìƒíƒœ ë¡œë“œ */
    try {
      const res = await fetch('/api/agents');
      if (res.ok) {
        const data = await res.json();
        /*
          M-4: ì‹¤ì œ ì‘ë‹µ í˜•íƒœ:
          {
            agents: [ { id, emoji, name, role, status: { active } }, ... ]
          }
          í•˜ìœ„ í˜¸í™˜ì„ ìœ„í•´ ê¸°ì¡´ ê°ì²´ í˜•íƒœ { id: statusString } ë„ ì§€ì›
        */
        if (Array.isArray(data.agents)) {
          data.agents.forEach(agent => {
            const status = agent.status?.active ? 'working' : 'idle';
            updateAgentStatus(agent.id, status);
          });
        } else {
          /* í•˜ìœ„ í˜¸í™˜: { shinnosuke: 'working', bo: 'completed', ... } í˜•íƒœ */
          Object.entries(data).forEach(([id, status]) => {
            updateAgentStatus(id, status);
          });
        }
      }
    } catch (_e) {
      /* ì„œë²„ ë¯¸ì—°ê²° ì‹œ ë¬´ì‹œ (ì •ì  ëª¨ë“œ) */
    }
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SSE ì—°ê²° (Server-Sent Events)
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  function connectSSE() {
    /* ì´ë¯¸ ì—°ê²° ì¤‘ì´ë©´ ìŠ¤í‚µ */
    if (state.eventSource) {
      state.eventSource.close();
      state.eventSource = null;
    }

    try {
      const es = new EventSource('/api/events/stream');
      state.eventSource = es;

      /* ì—°ê²° ì„±ê³µ */
      es.addEventListener('open', () => {
        setConnected(true);
        addEvent({
          agentId: null,
          message: 'SSE ìŠ¤íŠ¸ë¦¼ì— ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.',
          type: 'success',
        });
      });

      /*
        ì¼ë°˜ ë©”ì‹œì§€ ìˆ˜ì‹ 
        ì„œë²„ëŠ” ë‹¤ìŒ í˜•íƒœì˜ JSONì„ data í•„ë“œë¡œ ì „ì†¡:
        {
          type:      'event',               // ì´ë²¤íŠ¸ ì¢…ë¥˜
          agentId:   'shinnosuke',          // ì—ì´ì „íŠ¸ ID
          message:   'ì‘ì—…ì„ ì‹œì‘í•©ë‹ˆë‹¤.', // í‘œì‹œí•  ë©”ì‹œì§€
          eventType: 'info',               // info | success | warning | error
          timestamp: '2026-02-19T12:00:00Z',
          // ì„ íƒì  í•„ë“œ:
          status:    'working',            // ì—ì´ì „íŠ¸ ìƒíƒœ ë³€ê²½ ì‹œ
          stage:     'execution',          // ì›Œí¬í”Œë¡œìš° ìŠ¤í…Œì´ì§€ ë³€ê²½ ì‹œ
          phase:     '1/4',               // í˜ì´ì¦ˆ ë³€ê²½ ì‹œ
        }
      */
      es.addEventListener('message', (e) => {
        try {
          const data = JSON.parse(e.data);
          handleSSEMessage(data);
        } catch (err) {
          /* JSON íŒŒì‹± ì‹¤íŒ¨ ì‹œ í…ìŠ¤íŠ¸ ë©”ì‹œì§€ë¡œ ì²˜ë¦¬ */
          if (e.data && e.data.trim()) {
            addEvent({ agentId: null, message: e.data, type: 'info' });
          }
        }
      });

      /* ì»¤ìŠ¤í…€ ì´ë²¤íŠ¸: ì—ì´ì „íŠ¸ ìƒíƒœ ë³€ê²½ */
      es.addEventListener('agent_status', (e) => {
        try {
          const data = JSON.parse(e.data);
          /* M-2: ì„œë²„ëŠ” `agent` í•„ë“œë¥¼ ë³´ëƒ„, í•˜ìœ„ í˜¸í™˜ì„ ìœ„í•´ agentIdë„ ì§€ì› */
          const agentId = data.agent || data.agentId;
          if (agentId && data.status) {
            /* agent_start / agent_doneì„ statusë¡œ ë§¤í•‘ */
            const statusMap = { agent_start: 'working', agent_done: 'completed' };
            const mappedStatus = statusMap[data.status] || data.status;
            updateAgentStatus(agentId, mappedStatus, data.message);
            /* íƒ€ì„ë¼ì¸ì—ë„ ì¶”ê°€ */
            addTimelineEvent({
              agentId:   agentId,
              message:   data.message || (mappedStatus === 'working' ? 'Working...' : 'Done'),
              etype:     data.status === 'agent_start' ? 'agent_start' : 'agent_done',
              timestamp: data.timestamp ? new Date(data.timestamp) : new Date(),
            });
          }
        } catch (_) {}
      });

      /* ì»¤ìŠ¤í…€ ì´ë²¤íŠ¸: ìœ„ì„ */
      es.addEventListener('delegation', (e) => {
        try {
          const data = JSON.parse(e.data);
          updateDelegationFlow({ from: data.from, to: data.to });
          addTimelineEvent({
            agentId:   data.from,
            etype:     'delegation',
            from:      data.from,
            to:        data.to,
            task:      data.task || data.message,
            timestamp: data.timestamp ? new Date(data.timestamp) : new Date(),
          });
        } catch (_) {}
      });

      /* ì»¤ìŠ¤í…€ ì´ë²¤íŠ¸: ì±„íŒ… ë©”ì‹œì§€ */
      es.addEventListener('chat_message', (e) => {
        try {
          const data = JSON.parse(e.data);
          /* L-3: ì„œë²„ëŠ” `agent` í•„ë“œë¥¼ ë³´ëƒ„, í•˜ìœ„ í˜¸í™˜ì„ ìœ„í•´ agentIdë„ ì§€ì› */
          addChatMessage({
            agentId:   data.agent || data.agentId,
            message:   data.message,
            etype:     data.type,
            from:      data.from,
            to:        data.to,
            task:      data.task,
            timestamp: data.timestamp ? new Date(data.timestamp) : new Date(),
            isUser:    data.isUser || false,
          });
        } catch (_) {}
      });

      /* ì»¤ìŠ¤í…€ ì´ë²¤íŠ¸: Debate */
      es.addEventListener('debate', (e) => {
        try {
          const data = JSON.parse(e.data);
          handleDebateEvent(data);
          /* Debate ì‹œì‘ ì‹œ íƒ€ì„ë¼ì¸ ì´ë²¤íŠ¸ë„ ì¶”ê°€ */
          if (data.debate_type === 'start' || data.type === 'start') {
            addTimelineEvent({
              agentId:   'midori',
              message:   `í† ë¡  ì‹œì‘: ${data.topic || ''}`,
              etype:     'message',
              timestamp: data.timestamp ? new Date(data.timestamp) : new Date(),
            });
          }
        } catch (_) {}
      });

      /* ì»¤ìŠ¤í…€ ì´ë²¤íŠ¸: ì›Œí¬í”Œë¡œìš° ìƒíƒœ ë³€ê²½ */
      es.addEventListener('workflow_status', (e) => {
        try {
          const data = JSON.parse(e.data);
          /* M-3: ì„œë²„ëŠ” { workflow: { stage, phase, status } } í˜•íƒœë¡œ ë³´ëƒ„, í•˜ìœ„ í˜¸í™˜ì„ ìœ„í•´ data.stageë„ ì§€ì› */
          const stage      = data.workflow?.stage || data.stage;
          const phase      = data.workflow?.phase || data.phase;
          const phaseTitle = data.workflow?.phase_title || data.phase_title;
          if (stage) updateWorkflow(stage, phase, phaseTitle);
          /* workflow_update íƒ€ì„ë¼ì¸ ì´ë²¤íŠ¸ */
          if (data.message) {
            addTimelineEvent({
              agentId:   null,
              message:   data.message,
              etype:     'workflow_update',
              timestamp: data.timestamp ? new Date(data.timestamp) : new Date(),
            });
          }
        } catch (_) {}
      });

      /* ì—°ê²° ì˜¤ë¥˜ - EventSourceëŠ” ìë™ ì¬ì—°ê²°ì„ ì‹œë„í•˜ë¯€ë¡œ 'reconnecting' ìƒíƒœ í‘œì‹œ */
      es.addEventListener('error', () => {
        if (es.readyState === EventSource.CLOSED) {
          /* ì™„ì „íˆ ë‹«íŒ ê²½ìš° */
          setConnected(false);
        } else {
          /* CONNECTING ìƒíƒœ: ì¬ì—°ê²° ì‹œë„ ì¤‘ */
          setConnected('reconnecting');
        }
      });

    } catch (err) {
      /* EventSourceë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ” í™˜ê²½ */
      setConnected(false);
    }
  }

  /* SSE ì¼ë°˜ ë©”ì‹œì§€ ì²˜ë¦¬ (onmessage í•¸ë“¤ëŸ¬ìš©)
     data ì˜ˆìƒ í˜•íƒœ:
     {
       type:      'agent_start' | 'agent_done' | 'delegation' | 'message' | 'user_prompt' |
                  'tool_use' | 'stop' | 'session_start' | 'session_end' | 'workflow_update',
       agentId:   'shinnosuke',
       message:   'ì‘ì—…ì„ ì‹œì‘í•©ë‹ˆë‹¤.',
       eventType: 'info',         // ê¸°ì¡´ í˜¸í™˜ íƒ€ì…
       timestamp: '...',
       // delegation ì „ìš©:
       from:      'shinnosuke',
       to:        'nene',
       task:      'ìš”êµ¬ì‚¬í•­ ë¶„ì„',
       // ì—ì´ì „íŠ¸ ìƒíƒœ ì „ìš©:
       status:    'working',
       // ì›Œí¬í”Œë¡œìš° ì „ìš©:
       stage:     'execution',
       phase:     '1/4',
     }
  */
  function handleSSEMessage(data) {
    const etype     = data.type || null;
    const ts        = data.timestamp ? new Date(data.timestamp) : new Date();

    /* ì—ì´ì „íŠ¸ ìƒíƒœ ë³€ê²½ ì²˜ë¦¬ */
    if (etype === 'agent_start' && data.agentId) {
      updateAgentStatus(data.agentId, 'working', data.message);
      addTimelineEvent({ agentId: data.agentId, message: data.message, etype: 'agent_start', timestamp: ts });
      /* ì±„íŒ… ë·°ì—ë„ ë°˜ì˜ */
      if (data.message) {
        addChatMessage({ agentId: data.agentId, message: data.message, timestamp: ts });
      }
      return;
    }

    if (etype === 'agent_done' && data.agentId) {
      updateAgentStatus(data.agentId, 'completed', data.message);
      addTimelineEvent({ agentId: data.agentId, message: data.message, etype: 'agent_done', timestamp: ts });
      return;
    }

    /* ìœ„ì„ ì´ë²¤íŠ¸ ì²˜ë¦¬ */
    if (etype === 'delegation') {
      updateDelegationFlow({ from: data.from, to: data.to });
      addTimelineEvent({
        agentId: data.from,
        etype:   'delegation',
        from:    data.from,
        to:      data.to,
        task:    data.task || data.message,
        timestamp: ts,
      });
      /* ì±„íŒ… ë·°ì— ìœ„ì„ ë²„ë¸” ì¶”ê°€ */
      addChatMessage({
        agentId:   data.from,
        etype:     'delegation',
        from:      data.from,
        to:        data.to,
        task:      data.task || data.message,
        timestamp: ts,
      });
      return;
    }

    /* ì±„íŒ… ë©”ì‹œì§€ ì´ë²¤íŠ¸ ì²˜ë¦¬ */
    if (etype === 'chat_message') {
      addChatMessage({
        agentId:   data.agentId,
        message:   data.message,
        from:      data.from,
        to:        data.to,
        task:      data.task,
        timestamp: ts,
        isUser:    data.isUser || false,
      });
      return;
    }

    /* Debate ì´ë²¤íŠ¸ ì²˜ë¦¬ */
    if (etype === 'debate' || data.debate_type) {
      handleDebateEvent(data);
      if (data.debate_type === 'start' || data.type === 'start') {
        addTimelineEvent({
          agentId:   'midori',
          message:   `í† ë¡  ì‹œì‘: ${data.topic || ''}`,
          etype:     'message',
          timestamp: ts,
        });
      }
      return;
    }

    /* ì‚¬ìš©ì í”„ë¡¬í”„íŠ¸ ì´ë²¤íŠ¸ ì²˜ë¦¬ */
    if (etype === 'user_prompt') {
      addTimelineEvent({ agentId: null, message: data.message, etype: 'user_prompt', timestamp: ts });
      /* ì±„íŒ… ë·°ì— ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€ */
      if (data.message) {
        addChatMessage({ agentId: null, message: data.message, timestamp: ts, isUser: true });
      }
      return;
    }

    /* ì›Œí¬í”Œë¡œìš° ìƒíƒœ ë³€ê²½ ì²˜ë¦¬ */
    if (data.stage) {
      updateWorkflow(data.stage, data.phase, data.phase_title);
    }

    /* ê¸°ì¡´ status í•„ë“œ í˜¸í™˜ ì²˜ë¦¬ */
    if (data.agentId && data.status) {
      const statusMap = { agent_start: 'working', agent_done: 'completed' };
      const mappedStatus = statusMap[data.status] || data.status;
      updateAgentStatus(data.agentId, mappedStatus, data.message);
    }

    /* íƒ€ì„ë¼ì¸ ì´ë²¤íŠ¸ ì¶”ê°€ */
    if (data.message || etype) {
      addTimelineEvent({
        agentId:   data.agentId || null,
        message:   data.message,
        type:      data.eventType || 'info',
        etype:     etype,
        timestamp: ts,
      });
      /* message ì´ë²¤íŠ¸ëŠ” ì±„íŒ… ë·°ì—ë„ ì¶”ê°€ */
      if (etype === 'message' && data.message && data.agentId) {
        addChatMessage({ agentId: data.agentId, message: data.message, timestamp: ts });
      }
    }
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ì§„ì…ì 
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  document.addEventListener('DOMContentLoaded', init);
</script>

</body>
</html>
